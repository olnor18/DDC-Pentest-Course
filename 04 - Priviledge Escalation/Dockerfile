FROM ubuntu

ARG DEBIAN_FRONTEND=noninteractive
ARG DEBCONF_NONINTERACTIVE_SEEN=true

RUN apt-get update && apt-get install -y openssh-server\
    nano wget curl vim\
    supervisor\
    sudo\
    gcc\
    python3-pip\
    && rm -rf /var/lib/apt/lists/*

RUN mkdir -p /var/log/supervisor
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# apache config
ENV APACHE_RUN_USER www-data
ENV APACHE_RUN_GROUP www-data
RUN mkdir /var/run/apache2
ENV APACHE_LOG_DIR /var/log/apache2
RUN mkdir /var/www
RUN chown -R www-data:www-data /var/www/

# Configure ssh
RUN sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd
RUN mkdir /var/run/sshd
RUN service ssh start
COPY ssh-keys/ssh_host_ecdsa_key /etc/ssh/ssh_host_ecdsa_key
COPY ssh-keys/ssh_host_ecdsa_key.pub /etc/ssh/ssh_host_ecdsa_key.pub
RUN chmod 700 /etc/ssh/ssh_host_ecdsa_key.pub
RUN chmod 700 /etc/ssh/ssh_host_ecdsa_key

# Create users
RUN sed -i 's/DIR_MODE=0755/DIR_MODE=0700/g' /etc/adduser.conf
RUN groupadd developers
RUN useradd -ms /bin/bash -G users john
RUN echo 'john:Welcome2022!' | chpasswd
RUN useradd -ms /bin/bash -G users,developers olivia
RUN echo 'olivia:5fa4a28aa3a240b78680d0c464a2bf0f714a7970' | chpasswd
RUN useradd -ms /bin/bash -G users,developers stan
RUN echo 'stan:33f3a2927b3d5cec7d545dd145f5aa6f685c9429' | chpasswd

# Setup privesc to john
COPY --chown=olivia:olivia john/welcome.txt /home/olivia/welcome.txt
RUN chmod 644 /home/olivia/welcome.txt
COPY --chown=john:john john/flag.txt /home/john/flag.txt
RUN chmod 600 /home/john/flag.txt

# Setup privesc to olivia
COPY --chown=olivia:olivia olivia/program.c /home/olivia/program.c
RUN gcc /home/olivia/program.c -o /opt/getPublicIP
RUN chown olivia /opt/getPublicIP
RUN chgrp users /opt/getPublicIP
RUN chmod 4754 /opt/getPublicIP
COPY --chown=olivia:olivia olivia/flag.txt /home/olivia/flag.txt
RUN chmod 600 /home/olivia/flag.txt

# Setup privesc to stan
COPY --chown=stan:developers stan/app/app.py /app/app.py
RUN chmod 770 /app/app.py
COPY --chown=stan:stan stan/flag.txt /home/stan/flag.txt
RUN chmod 600 /home/stan/flag.txt

# Setup privesc to root
COPY --chown=root:root root/logs /etc/sudoers.d/logs
COPY --chown=root:root root/flag.txt /root/flag.txt

CMD ["/usr/bin/supervisord"]